{% extends 'tph_system/base.html' %}

{% block func_buttons %}
<!-- Кнопка модального окна для ввода графика -->
{% if perms.tph_system.add_schedule %}
<button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#modal-schedule-form">
    Новая Запись
</button>
{% endif %}
{% endblock func_buttons %}

{% block content %}
<div class="container cont_store">
    <div class="card shadow" style="width: 100%; min-width: 1000px">

        <!-- Модальное окно - ввод новой техники -->
        <div class="modal fade" id="modal-schedule-form" data-bs-backdrop="static" data-bs-keyboard="false"
             tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="staticBackdropLabel">Добавление новой записи в график</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <!-- Форма ввода данных -->
                    <form method="post">
                        <div class="modal-body">
                            {% csrf_token %}
                            {{ form.staff }}<br>
                            {{ form.store }}<br>
                            {{ form.position }}<br>
                            {{ form.date }}<br>
                            <span>{{ error }}</span>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" type="submit">Сохранить</button>
                            <button  class="btn btn-danger" type="reset" data-bs-dismiss="modal">Отмена</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div>

    <!-- Таблица с графиком -->
    <div class="card shadow" style="width: 100%; min-width: 1000px">
        <div class="card-header">
            <h4 class="card-title">
                График работы сотрудников <br>

                <div class="card card-body" id="cs_filter">
                    <div class="schedule-controls">
                        <button class="btn btn-primary" id="prev-week" style="margin-right: 20px">← Предыдущая неделя</button>
                        <span id="current-week">Неделя с <span id="start-date">{{ start_date|date:"d.m.Y" }}</span></span>
                        <button class="btn btn-primary" id="next-week" style="margin-left: 20px">Следующая неделя →</button>
                    </div>
                </div>
            </h4>
        </div>

        <table class="table table-hover table-bordered align-middle" id="schedule-table">
            <thead>
                <tr>
                    <th>Сотрудник</th>
                    {% for i in "0123456"|make_list %}
                        <th class="date-header"></th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
    </div>

</div>



<script>
$(document).ready(function() {
    // Инициализация текущей даты из Django context
    var currentDate = new Date('{{ start_date|date:"Y-m-d" }}');

    // Функция для форматирования даты в строку YYYY-MM-DD
    function formatDate(date) {
        var d = new Date(date),
            month = '' + (d.getMonth() + 1),
            day = '' + d.getDate(),
            year = d.getFullYear();

        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;

        return [year, month, day].join('-');
    }

    // Функция для отрисовки расписания на текущую дату
    function colorset(val){
        switch(val){
            case "BWVgs": id_store_select.style.color = "26ff31"; break;
            case "LLGgr": id_store_select.style.color = "ff2676"; break;
            case "LLKun": id_store_select.style.color = "2664ff";
        }
    }

    // Функция для обновления таблицы расписания
    function updateTable(newDate) {
        $.ajax({
            url: '{% url "schedule" %}',
            data: {
                'start_date': formatDate(newDate)
            },
            dataType: 'json',
            success: function(data) {
                var tbody = $('#schedule-table tbody');
                tbody.empty(); // Очищаем существующее содержимое таблицы

                // Обновляем отображаемую дату начала недели
                $('#start-date').text(new Date(data.start_date).toLocaleDateString('ru-RU'));

                // Обновляем заголовки с датами
                $('.date-header').each(function(index) {
                    var headerDate = new Date(data.start_date);
                    headerDate.setDate(headerDate.getDate() + index);
                    $(this).text(headerDate.toLocaleDateString('ru-RU', {weekday: 'short', day: '2-digit', month: '2-digit'}));
                });

                // Создаем строки таблицы для каждого сотрудника
                $.each(data.schedule_data, function(index, staff) {
                    var row = $('<tr>');
                    row.append($('<td>').text(staff.staff_name + ' ' + staff.staff_f_name));

                    // Добавляем ячейки с select для каждого дня недели
                    $.each(staff.schedule, function(index, day) {
                        var select = $('<select>')
                            .addClass('schedule-select form-select')
                            //.attr('onchange', 'colorset(this.value)')
                            .attr('id', 'id_store_select')
                            .attr('data-employee', staff.staff_id)
                            .attr('data-date', day.date);

                        // Добавляем опции в select
                        $('<option>').val('').text('').appendTo(select);
                        {% for store in stores %}
                        $('<option>').val('{{ store.short_name }}').text('{{ store.short_name }}').appendTo(select);
                        {% endfor %}

                        // Устанавливаем текущее значение смены
                        select.val(day.store);

                        row.append($('<td>').append(select));
                    });

                    tbody.append(row);
                });
            }
        });
    }

    // Обработчики кликов по кнопкам смены недели
    $('#prev-week').click(function() {
        currentDate.setDate(currentDate.getDate() - 7);
        updateTable(currentDate);
    });

    $('#next-week').click(function() {
        currentDate.setDate(currentDate.getDate() + 7);
        updateTable(currentDate);
    });

    // Инициализация таблицы при загрузке страницы
    updateTable(currentDate);

    // Обработчик изменения значения в select
    $(document).on('change', '.schedule-select', function() {
        var employeeId = $(this).data('employee');
        var date = $(this).data('date');
        var store = $(this).val();

        $.ajax({
            url: '{% url "update_schedule" %}',
            method: 'POST',
            data: {
                'staff_id': employeeId,
                'date': date,
                'store': store
            },
            success: function(response) {
                if (response.status === 'success') {
                    console.log('График для сотрудника успешно ' +
                        (response.action === 'deleted' ? 'очищен' :
                         response.action === 'created' ? 'создан' : 'обновлен'));
                } else {
                    console.error('Ошибка при обновлении графика для сотрудника:', response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('Ошибка при отправке запроса:', error);
            }
        });

        console.log('Сотрудник ' + employeeId + ', дата ' + date + ', точка ' + store);
    });
});
</script>

{% endblock %}